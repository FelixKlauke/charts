steps:
# Create Chart skeleton
- name: 'debian:stable-slim'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
        mkdir -p knative/templates
        mv Chart.yaml ./knative
        mv values.yaml ./knative

# Get the Istio manifest
- name: 'gcr.io/cloud-builders/wget'
  args: ['-O', 'knative/templates/istio.yaml', 'https://raw.githubusercontent.com/knative/serving/master/third_party/istio-1.0.2/istio.yaml']

# Get the Knative manifest
- name: 'gcr.io/cloud-builders/wget'
  args: ['-O', 'knative/templates/knative.yaml', 'https://github.com/knative/serving/releases/download/v0.1.1/release-no-mon.yaml']

# https://github.com/knative/build/releases/tag/v0.1.2 speeds up builds significantly
- name: 'debian:stable-slim'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
        sed -i 's/a47ea977bef1889c4b29d8dd5c28af923c40a61c12e823d1da6ff0cbeeb41d6d/fb90fcb6b8b3ebb5a422dfc826473255f697cadae592d0bc5a723af139109f26/' knative/templates/knative.yaml
        sed -i 's/15fac1ab6052706749695418845834f53070df0e6d4778b7225c5ce0af8ca160/414cae3a0896b09c276d17301c53f88abbed8a5e412a4f117cc535bf37012f1f/' knative/templates/knative.yaml

# Templatize the chart
- name: 'debian:stable-slim'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
        sed -i 's/example.com/{{ .Values.domain }}/' knative/templates/knative.yaml
        sed -i 's/LoadBalancer/{{ .Values.istioIngressType }}/' knative/templates/istio.yaml

# Initialize Helm without Cluster
- name: 'gcr.io/triggermesh/helm'
  args: ['init', '--client-only']

# Install gcs plugin
- name: 'gcr.io/triggermesh/helm'
  args: ['plugin', 'install', 'https://github.com/viglesiasce/helm-gcs.git']

# Package the chart
- name: 'gcr.io/triggermesh/helm'
  args: ['package', 'knative']

# Create repo directory
- name: 'debian:stable-slim'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
        mkdir repo
        mv knative-0.1.3.tgz ./repo

# Generate index
- name: 'gcr.io/triggermesh/helm'
  args: ['repo', 'index', '--url', 'https://storage.googleapis.com/triggermesh-charts', './repo']

# Push index to gcs bucket
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', './repo/index.yaml', 'gs://$PROJECT_ID-charts/index.yaml']

# Push it to gcs bucket
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', './repo/knative-0.1.3.tgz', 'gs://$PROJECT_ID-charts/knative-0.1.3.tgz']

# Build the installer
- name: gcr.io/kaniko-project/executor:latest
  args: ["--dockerfile=./installer/Dockerfile",
         "--context=dir://.",
         "--destination=gcr.io/$PROJECT_ID/knative-installer:latest"]
